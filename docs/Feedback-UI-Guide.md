# ğŸ¨ Feedback UI Quick Guide

## What Users See in Risk Dashboard

### Section 1: Feedback Statistics (Top)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ¤– ML Predictions & Feedback                               â”‚
â”‚  Help improve our AI by providing feedback on predictions  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Total   â”‚  â”‚ Accuracy â”‚  â”‚Correct-  â”‚  â”‚Uncertain â”‚  â”‚
â”‚  â”‚ Feedback â”‚  â”‚   Rate   â”‚  â”‚  ions    â”‚  â”‚          â”‚  â”‚
â”‚  â”‚    19    â”‚  â”‚   0.0%   â”‚  â”‚    5     â”‚  â”‚    0     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Section 2: Prediction Cards (Expandable)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ¯ Review ML Predictions                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  â–¼ ğŸ“Š 10010001 - Cash on Hand (Score: 0.85)                â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚    â”‚
â”‚    â”‚  â”‚ Anomaly  â”‚  â”‚ Priority â”‚  â”‚  Needs   â”‚       â”‚    â”‚
â”‚    â”‚  â”‚  Score   â”‚  â”‚  Score   â”‚  â”‚Attention â”‚       â”‚    â”‚
â”‚    â”‚  â”‚   0.85   â”‚  â”‚  8.5/10  â”‚  â”‚   Yes    â”‚       â”‚    â”‚
â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚    â”‚
â”‚    â”‚                                                   â”‚    â”‚
â”‚    â”‚  Balance: â‚¹125,450,000                           â”‚    â”‚
â”‚    â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚    â”‚
â”‚    â”‚  Was this prediction helpful?                    â”‚    â”‚
â”‚    â”‚                                                   â”‚    â”‚
â”‚    â”‚  [ âœ… Correct ]  [ âŒ Incorrect ]  [ â“ Uncertain ]â”‚    â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                              â”‚
â”‚  â–¶ ğŸ“Š 10020002 - Accounts Receivable (Score: 0.72)        â”‚
â”‚  â–¶ ğŸ“Š 20030001 - Trade Payables (Score: 0.68)             â”‚
â”‚  â–¶ ğŸ“Š 40010001 - Revenue (Score: 0.61)                    â”‚
â”‚  â–¶ ğŸ“Š 50020001 - Operating Expenses (Score: 0.55)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Section 3: Correction Form (Shown After Clicking âŒ Incorrect)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â–¼ ğŸ“Š 10010001 - Cash on Hand (Score: 0.85)                â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚    â”‚  [Predictions shown above...]                    â”‚    â”‚
â”‚    â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚    â”‚
â”‚    â”‚  Provide Correction:                             â”‚    â”‚
â”‚    â”‚                                                   â”‚    â”‚
â”‚    â”‚  Actual Anomaly Score (0-1)  Actual Priority(0-10)â”‚   â”‚
â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚    â”‚
â”‚    â”‚  â”‚      0.3        â”‚         â”‚       5.0       â”‚â”‚    â”‚
â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚    â”‚
â”‚    â”‚                                                   â”‚    â”‚
â”‚    â”‚  Comments (optional)                             â”‚    â”‚
â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
â”‚    â”‚  â”‚ This balance is expected for month-end    â”‚  â”‚    â”‚
â”‚    â”‚  â”‚ closing. No anomaly here.                 â”‚  â”‚    â”‚
â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
â”‚    â”‚                                                   â”‚    â”‚
â”‚    â”‚  [ Submit ]  [ Cancel ]                          â”‚    â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Section 4: Feedback History (Bottom)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“ˆ Recent Feedback History                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Account    â”‚ Type     â”‚ Feedback  â”‚ Predicted â”‚ Actual    â”‚
â”‚  Code       â”‚          â”‚ Type      â”‚ Value     â”‚ Value     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 10010001    â”‚ anomaly  â”‚ incorrect â”‚   0.85    â”‚   0.30    â”‚
â”‚ 10010001    â”‚ priority â”‚ incorrect â”‚   8.50    â”‚   5.00    â”‚
â”‚ 10020002    â”‚ anomaly  â”‚ correct   â”‚   0.72    â”‚     -     â”‚
â”‚ 20030001    â”‚ priority â”‚ uncertain â”‚   6.80    â”‚     -     â”‚
â”‚ 40010001    â”‚ anomaly  â”‚ incorrect â”‚   0.61    â”‚   0.45    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## User Workflow

### Happy Path (Correct Prediction)
1. User opens Risk Dashboard
2. Scrolls to "ğŸ¤– ML Predictions & Feedback"
3. Clicks expander for an account
4. Reviews prediction (anomaly: 0.85, priority: 8.5/10)
5. Clicks **âœ… Correct** button
6. Sees success message: "âœ… Thank you! Feedback recorded."
7. Feedback stored in MongoDB
8. Statistics update automatically

**Time**: ~10 seconds

### Correction Path (Incorrect Prediction)
1. User opens Risk Dashboard
2. Scrolls to "ğŸ¤– ML Predictions & Feedback"
3. Clicks expander for an account
4. Reviews prediction (anomaly: 0.85, priority: 8.5/10)
5. Disagrees - clicks **âŒ Incorrect** button
6. Form appears with number inputs
7. Enters actual anomaly score: 0.3
8. Enters actual priority score: 5.0
9. Adds comment: "Expected for month-end"
10. Clicks **Submit**
11. Sees success message: "âœ… Corrections submitted!"
12. Feedback stored with actual values
13. Available for next retraining cycle

**Time**: ~30 seconds

### Uncertain Path
1-4. (Same as above)
5. Unsure - clicks **â“ Uncertain** button
6. Sees info message: "ğŸ“ Feedback recorded as uncertain."
7. Feedback stored without actual values
8. System knows to get more opinions

**Time**: ~10 seconds

---

## Technical Details

### State Management
```python
# Streamlit session state tracks correction forms
st.session_state[f'fb_{idx}_{account_code}_show_correction'] = True

# Unique keys prevent conflicts
key=f"fb_{idx}_{account_code}_correct"
```

### Feedback Collection
```python
from src.feedback_handler import MLFeedbackCollector

collector = MLFeedbackCollector()

# Quick feedback (correct/uncertain)
collector.collect_prediction_feedback(
    account_code='10010001',
    prediction_type='anomaly',
    predicted_value=0.85,
    feedback_type='correct',
    user_id='user@example.com',
    period='Mar-24',
    entity='AEML'
)

# Correction with actual value
collector.collect_prediction_feedback(
    account_code='10010001',
    prediction_type='anomaly',
    predicted_value=0.85,
    actual_value=0.30,  # User's correction
    feedback_type='incorrect',
    user_id='user@example.com',
    comments='Expected for month-end',
    period='Mar-24',
    entity='AEML'
)
```

### Statistics Display
```python
stats = collector.get_feedback_stats()
# Returns:
# {
#   'total_feedback': 19,
#   'correct': 0,
#   'incorrect': 5,
#   'uncertain': 0,
#   'accuracy_rate': 0.0,
#   'correction_rate': 26.3
# }
```

---

## Design Principles

### âœ… Quick Feedback First
- Default action = one click
- **âœ… Correct** button requires no form
- Most predictions are correct, so optimize for that

### âœ… Progressive Disclosure
- Correction form only shown when needed
- Expandable cards hide complexity
- Advanced options (comments) are optional

### âœ… Clear Visual Hierarchy
- Statistics at top (overview)
- Predictions in middle (action area)
- History at bottom (reference)

### âœ… Immediate Feedback
- Success messages after submission
- Statistics update in real-time
- Rerun refreshes the page

### âœ… Mobile-Friendly
- Streamlit columns adapt to screen size
- Buttons stack vertically on mobile
- Forms are touch-friendly

---

## Accessibility

- **Color Coding**:
  - âœ… Green = Correct/Success
  - âŒ Red = Incorrect/Error
  - â“ Blue = Uncertain/Info

- **Icons**:
  - All buttons have emoji + text
  - Not relying on color alone

- **Clear Labels**:
  - "Actual Anomaly Score (0-1)"
  - "Actual Priority (0-10)"
  - Range indicators prevent invalid input

---

## Future Enhancements

### 1. Bulk Feedback
- Select multiple accounts
- Apply same feedback to all
- "Mark all as reviewed"

### 2. Keyboard Shortcuts
- `C` = Correct
- `I` = Incorrect
- `U` = Uncertain
- `Enter` = Submit form

### 3. Confidence Slider
- Instead of binary correct/incorrect
- Slider from "Completely Wrong" to "Completely Right"
- Captures nuanced feedback

### 4. Expert Mode
- Show feature importance
- Display model confidence
- Explain prediction reasoning

### 5. Gamification
- Leaderboard of most helpful reviewers
- Badges for feedback milestones
- Accuracy tracking per user

---

## Troubleshooting

### Issue: Buttons not working
**Cause**: Unique key collision
**Fix**: Each button has `key=f"fb_{idx}_{account_code}_action"`

### Issue: Form doesn't appear after clicking âŒ
**Cause**: Session state not updating
**Fix**: Added `st.rerun()` after button click

### Issue: Feedback not saving
**Cause**: MongoDB connection error
**Fix**: Check `MONGODB_URI` environment variable

### Issue: Statistics not updating
**Cause**: Cache not cleared
**Fix**: Set `ttl=300` on `@st.cache_data`

---

## Testing Checklist

- [ ] Click **âœ… Correct** â†’ See success message
- [ ] Click **âŒ Incorrect** â†’ Form appears
- [ ] Fill form â†’ Click Submit â†’ See success message
- [ ] Click Cancel â†’ Form disappears
- [ ] Check feedback history â†’ New entry at top
- [ ] Check statistics â†’ Numbers updated
- [ ] Open different account â†’ Independent forms
- [ ] Refresh page â†’ Feedback persists (MongoDB)

---

**Built by**: Project Aura Team
**Date**: November 8, 2024
**Status**: âœ… Fully Integrated and Tested
